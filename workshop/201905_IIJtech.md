# IIJ Technical NIGHT vol.7「まだまだ現役！モダンなメールシステムと迷惑メール最前線！」

[link](https://eng-blog.iij.ad.jp/archives/3000)

@kabukawa #iij_its で検索するとスライド

## メールシステムの基本のき
ネットワーククラウド本部 アプリケーションサービス部 サービス開発課 土川 智昭

> 使えて当たり前のメールシステムを支える技術やソフトウェアについての基本をわかりやすく紹介します。30年以上の歴史を持つメールの全容を一から知るのは容易ではありませんが、このセッションではメールを支えてきたソフトウェアやメールの基本の仕組みについておさらいし、これまでのメールがチョットワカルようなお話をします。

メール配送でISPが担っている箇所
SMTPサーバ(port 25)の管理運用 クライアントサイドでは無いですよ〜
POP3サーバ　IMAPサーバ

近年の電子メールは仕組みを理解する必要がない

mail用語

- MTA
メール配送を担う無ログラムの総称 sendmail postfix etc

- MUA
メールクライアント thunderbird etc

- MDA　MSA

- バウンスメール
エラーメールの事(相手に届かなかったときに来るやつ)

1. メール配送はトランザクション
1通ごとにfsync どのMTAも同様　消失しないようにリレー

1. エンベロープとヘッダー
MTAの使うアドレス情報はエンベロープ，実際にクライアントソフトが見せているFromはへーだー

改善状況
SPF エンベロープFrom詐称の検証
DKIM
DMARC
ARC これはInternetDraft2018で提唱
DANE,MTA-STS 平文ではなくTLSを強制する
> SMTPで厳格にTLSを使うために、メールサーバ(MTA)がTLSに対応していることをポリシーとして宣言して、検証できるようにする仕組み

現在のメール技術について

## メールインフラの生々しい運用

> 現代の迷惑メールは広告のような「単に迷惑である」域を超え、脅迫やネットバンキングアカウントの詐取などの直接的な金銭獲得の手段として利用されています。本セッションでは運用者から見た迷惑メールの特徴と、設備面での迷惑メールとの戦いを紹介します。

Spamメールとその工夫
フィッシングメールは会社に影響を与える，偽のログイン画面
見た目で分かりづらいのが，ログイン失敗メール Amazonなどがログイン通知
メールサーバ管理者を装うもの　アカウント掌握が目的

請求書等の添付メール
malwareのダウンローダ　難読化によりハッシュ改変でIPSをすり抜ける

bitcoin関連の脅迫状
fromとキューが同じ

自社ドメインへの詐称
SPF passを通す 使い捨てドメインにallを付加 spfはあくまでドメイン保持者
送信IPで特定は困難 botnetの出口はいっぱい
送信数の調整
受診者を焦らせる　「支給」「本日中」
丁寧な説明でセキュリティ機構をユーザに解除させる

対策
複数エンジンの導入　迷惑メールの場合は誤判定が多い(最新のデータが必要)
抜けたぶんに対してスパムフィルタをかける

キャンペーン時は迷惑メールが普段の数十倍やってくる

業務メールはハニポに届いたものをブラックリスト化すれば出来なくはない
安否確認は普段観測されないドメインゆえリンク付きかつ短期間に大量 = まるでスパムキャンペーン

管理者はAntiVirus/AntiSpamを導入することが前提
送信認証フィルタ大事　似たものは通過するので十分ではない　
SPEのないドメインが最近狙われている SPFを自社ドメインにせっていしよう
`example.com. IN TXT "v=spf1 -all"`

## 高トランザクションシステムとしてのメールシステム

> ISP が運用するメールシステムでは極めて大きな流量のメールを処理しています。本セッションでは、メールシステムの“メール”という単語に囚われすぎることなく、汎用的な視点で大規模メールシステムの要件と特性を考察します。また、この考察を踏まえて IIJ のメールシステムのアーキテクチャについて紹介します。

SMTP / MIME が基本
メールゲートウェイ
外部のメールスプールの前でフィルターなどを実行するシステム

まぁフィルタはいっぱい
MSファイル形式のフィルタとかあるのか
多段MTAはバケツリレー毛形式で別機能を組み込みやすい
hoge社のアンチウイルスエンジン，fuga社の迷惑メール判定エンジン，OSS
ついつい段数が増えていく　MTA間で処理の重複が多い，サーバリソースに対する負担
メールが到達しなかった場合，様々な運用手順を確認しないといけない　追跡調査が大変になる　受信処理の重さ

メールを失わないこと
書き出しが担保される前に，前段成功を返さないこと
冗長性のあるストレージを使う　しかし金がかかる
CPUリソースのボトルネックはアンチウイルスソフト
zipファイルの展開はコンテナファイルであるためストレージの負荷になりやすい
そこでメモリに展開する　ハード面のボトルネックをCPUに移せる

ストレージI/OはSSDを使うことで解決
様々なフィルタを一台で実現できるMTAがあればいい(拡張も見込んで)
無いこともない　ベンダ製MTA
MTAというよりメールに特化したインタプリタ　DSLの提供もある　ソフトウェアの組み込みも柔軟
ベンダロックインのリスク 機能拡張は自分たちでできなくなる 設定変更以外何も出来ぬ
独自の遊びができなくなる 不具合すら直してくれない場合も
sendmail?

それじゃ内製で　という方針になる
特徴の把握が大事　突発的な負荷状態への対策　安定稼働が最前提
強靭なキューが必要　レスポンスタイムにはシビアではない
Cppが活躍しそう
> web res time 100ms

当然セキュリティベンダの製品はブラックボックス化しているので，推測してMTAのパフォーマンスを定めないといけない．動作の詳細がわからないから特性を定期的に見極める必要がある
DNS lookupではCPUが暇な状態になりやすい

C10K問題

--> イベント駆動型アーキテクチャ　I/O多重化　スレッドプールに組み合わせる

今度はメモリアロケータがボトルネックになりつつある