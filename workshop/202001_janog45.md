## そろそろSSL通信に本気出して向き合ってみる
杉井さん

twitter_memo_user: @goto_ipv6

自組織でNW運用監視となった想定で所感
SSL絡みの要望が多い

- SSLの現状
  - 常時SSLは76.2%(2810社)
  - 常時SSL = トップページ以外もSSL化
  - オリンピックにかけてモバイルのSSL化は４倍に
  - GoogleはYouTubeもSSL化が完了している
  - トラフィックのおよそ８割はSSL化してるとみていい

- 実在証明
  - 認証局による「本人(発行者)確認」
  - ブラウザに信頼できる認証局があらかじめimport
  - オレオレ証明書だと認証局があやしいので警告
  - DV/OV/EV :EV証明書が一番セキュア

- 暗号化通信
  - 公開鍵よりサーバーしか開けられぬ公開Boxという認識でいるらしい
  - E2Eによる暗号化

- 組織から見て「鍵マーク」があれば安全なのか
  - ゆうちょのフィッシングサイト，認証は通っている
  - コンテンツの安全性まで保証はできない
  - NW機器でパケットの中身を見るTipが少ない
  - 流れてくるコンテンツの危険性を中身で判断できない
  - エンドポイントに脆弱性があると防ぎようがなくなってしまう
  - つまり通信の８割でFWは素通しということ

- L2L3での対抗策
  - 証明書ベースのインスペクション
    - サーバのホスト名を確認
      - 証明書のCN
      - CLIENT HELLOのSNI
      - これはあくまでHOST名
  - SSL Deep inspection
    - MinM 中間車攻撃のロジックに近い
    - 社内水際のサーバでSSLを終了する
    - 外部サーバとは別のSSLセッションを行う
    - 社内のサーバで悪性トラフィックを落とす
    - 社内で証明書エラー対応が必要になる
      - AD + edgeならちょっと楽
      - Issuerが別名義となるので，ブラウザでお燗されていない俺俺認証局になっちゃう
    - つまり組織内に証明書を配布せねば...
  - SSLオフロードは復号化したトラフィックを外部サーバへ送る
    - 負荷軽減のため

- 社員が個人名義のクラウドを...
  - 管理側はちょっと嫌
  - MSはProxyとSSL Inspectionしてくれと
  - HTTPヘッダに自社タグ(文字列)を埋め込んではじく
  - 証明書はWindows ADで一応配布可能
  - それでもSSL Inspectionに踏み切れない理由
    - 運用負荷 (CA証明書の配布)
    - 適切な除外リストのメンテナンス
        - 銀行口座へのアクセスも見れてしまうため
    - パフォーマンス

- SSL Inspection
  - パフォーマンスの劣化が激しいのでスコープを考えねばならない

- エンドポイントでいいのでは？
  - 最終お水際
  - そこでアラートに紀付けるだけの人員がいるかどうか
  - エンド側のパッチが遅れていた場合とかが考えられる
  - 多層防御という観点から複数いれてあげて，低減すべき

- SSL 脆弱では？
- TLSをお使いください

## 攻撃インフラに用いられるドメインに対する新たなアプローチの検討
佐々木さん


- 不正ドメインのテイクダウンについて
- `.jp` 以外のお話
    - 法律をうまく適用して、根本から根絶できれば

- 差止請求権 商標法 第三十六条
- 差し押さえ：証拠物を強制処分により押さえる
  - 電子データも
- 差し止め：不法行為を止めるよう請求
  - 商標が勝手に使われた場合など 

- テイクダウンの依頼はサーバ管理者へ任意の依頼になる
  - 事業者の約款やその国の法令と一致しなければやってもらえない場合に
- 悪性ドメインの準備段階は検知しにくい
- テイクダウンは攻撃が起きたあとのことが多い

- MSの事例
  - 民事手続きで訴訟できる
    - 公開文書は数百ページあるので，それをみてカウントした(すごい)
  - APT28関連のドメイン差し押さえ
  - TRO
  - .com/.netの差止めが多い
    - 誤認されやすいので
  - ドメインを止める時に相手へ通知しない理由を700ページも裁判所に提出している

- 国内なら商標侵害として
  - 両者が国内のケース多め
  - MSのようなケースが国内の裁判でできるか不明
  - 米国で訴訟するとできるかな: JohnDoe...
  - 条件を満たせば通知前差止めもできる

  - 北米で訴訟という方法は、実際に可能なのかを 3月末までに調査中
    - 調査対象の手段(案)
      - 候補1：日本国内の民間団体が米連保地裁における差し止め請求
      - 候補2：統一ドメイン名紛争処理方針で
  - 訴訟コストが現在不明，弁護士へ相当な報酬がある，日本でも企業判断できるのか
  - 各種手続きに速やかに対応できるレジストラとそうでないレジストラの調査
  - 失効ドメインの取り扱い
    - シンクホールとして管理している団体へ委託されるのか

- 様々な訴訟を包括的に組み合わせていくことが重要になるかしれない

- resit script社
  - ダークマーケットのテイクダウン実績がある
  - 裁判してるわけではない，グレーな可能性もある
  - 法的な精度が重要かも
    - 国内でできる範囲も確かに重要
    - 約款の問題でできない企業も存在している
    - できることの調査もしていきたい
- 各国で情報共有はさかんなのか
  - DBがあるわけではない
  - CERTによる連絡体系
  - 統一しているわけではない
  - 有志
- テイクダウンをJPCERTでシンクホール化するメリットは？/APTで差止めするタイミングとしてベストなのは
  - 差止めはお金の関係で厳しさがある
  - 当事者がアクションできるよう調査するのが役割
  - ベストタイミングに明確な答えはない
- 相手が国外たとえば中国だとどうなるだろう
  - 国個別の障壁は感じていない
  - 各国の法令次第
- 移管されたドメインの管理料はだれが？
  - ここはまだ調査中
  - シャドウサーバへ譲渡
  - 負担の仕方は他の機関と話し合っていく
  - ICANミーティングなどどうでしょう

## public DNS とプライバシー

山口さん
- ISPのフルリゾルバ
  - ユーザーとフルリゾルバは同一ネットワーク内
  - 中間者攻撃は困難
  - 平文でも盗聴の危険性は低い
- Public DNS
  - 中間者攻撃ができてしまう
- 平文DNSは危険なのか？
  - ISPで自動設定されるフルリゾルバを使うのであれば
    - 従来の平文DNSでも盗聴の危険性は低い
  - Public DNS を使うのであれば
    - 平文DNSは安全ではない
  - CloudFlare の経路がハイジャック

- DoH/DoT ユースケース
  - 自動設定されるフルリゾルバが信頼できない
    - 代わりに Public DNS を
  - Public DNS への途中経路での中間者攻撃を回避
  - This is DoH/DoT 

- ISP でも DoH/DoT をやればいいじゃん
  - 設定を配布する手段がボトルネック
  - ユーザーには手動での設定が必要
  - Public DNS を使う場合も手動での設定が必要
    - それならユーザはPublic DNSを選んでしまう

- 従来のDNSでユーザートラッキング
  - IPアドレス only
  - NAT の向こうはわけわかめ

- DoH/DoT ユーザートラッキング
  - NATの先を見たい
  - セッションによるユーザー区別
  - セッション再開可能
    - IPアドレスが変わってもユーザーを識別できるよ
    - (ある程度)
  - DoH/DoT HTTP にリクエストヘッダーがある
    - いろんな情報を取得できる 
  - フルリゾルバは暗号化したほうが(返って)ユーザの情報を得やすい

- フルリゾルバは信頼できるのか？
  - DoH/DoT でも、キャッシュされた情報の正しさは担保できない
    - 担保にはDNSSECが必要

- Public DNSの試み
  - Google
    - EDNS Client Subnet
    - 権威サーバーにクライアントのIPアドレスを通知
  - Quad9
    - マルウェア配布サイトのブロッキング
  - IIJ
    - ポルノブロッキング

- EDNS Client Subnet
  - CDN
  - 一番近いエッジサーバーからコンテンツを配信したいが！
  - クライアントの IPアドレスを広告
    - /24

- 暗号化DNSで検閲の回避
  - mawareにとっても活動が隠蔽できてしまう

- Public DNS とプライバシー
  - 膨大なプライバシーが Public DNS 事業者の手に

- ISPのDNSでも契約約款はあるよね...

- JANOG45 の会場で自動設定されるDNSですが…
  - Google Public DNS の IPアドレス
  - JANOG 参加者は Google のプライバシーポリシーに同意している？

- ISPのフルリゾルバ&プライバシー
  - エンドユーザーからのフルリゾルバの問い合わせも通信の秘密の対象
    - コンセンサス
  - プライバシーの観点からも個々の問い合わせについての知得も行わない
  - 例外
    - 児童ポルノ
    - マリシャスなサイト

- 「海賊版サイトブロッキング」問題
  - 司法の場でもコンセンサスが取れているのではなかろうか

石田さん
- フルリゾルバ運用からの懸念
  - DoT/DoHが主流となると
    - フルリゾルバがPublicに巻き取られる
    - 自社の利用者へDoT/DoHを促してしまう懸念
    - ISPのフルリゾルバでも他対応すべき？
  - 対応しない場合
    - ISPはフルリゾルバの運用から開放される
    - 一部のみでPublic
      - 同一ユーザが異種のフルリゾルバを利用することによる不具合
        - 名前解決ができない場合の原因の切り分けが困難に
      - CDN利用の不整合
        - DNS負荷分散によるサーバ選択が最寄りではなくなる
        - 解決にはPublicを提供するCDNプロバイダへECS(RFC 7871)の実装が必要
      - 運用管理面
        - 設備設計が困難
        - 接続元のアクセスコントロール
        - qpsは増えるのか減るのか
        - 接続元のアクセスコントロール
  - DoT/DoHの運用
    - 対応のためのシステム構成はどうするのか
    - スタブリゾルバの設定
      - FQDN or IP
    - 証明書？
      - WebPKIの証明書
- https://eng-blog.iij.ad.jp/archives/5298

バウ氏
- Google Public DNS
  - 安定的かつ個々のスペックに応じたDNSの提供
  - 数百万のクエリーを処理
- 理念
  - 通信のプライバシー
  - データ取り扱いのプライバシー
  - 実装の概要はRFC7626

- プライバシーポリシーについて
  - 個人特定は48時間で削除
  - DDoS 攻撃を回避するため
  - アクセスできる人は制御され記録されている
  - 広告には利用しない


## パケット処理の独自実装や高速化手法の比較と実践

- 最新のコードはGitHub

- 実装の理由
  - パケット処理の独自実装はデータプレーンの理解につながるよ
  - 楽しさある

- HW実装
  - 並列処理はミソ
  - 周波数が低くてもパケット処理に耐えうる性能を発揮できる
  - HWのリソース
    - 配線が多くなる処理 = 回路がいっぱい
    - パケット全体の変更などは厳しい
    - いかにテーブルを分割するかが重要
    - ペイロードの一部をヘッダーとみなすことも

- FPGA/ASIC
  - FPGAは消費電力が大きい，学習コストがどうしても高くなる
    - 商用レベルを試すとコンパイルに１日かかることも
  - ASICは回路自体は固定，納期までに月単位を要する

- P4
  - ASICなどでパケット処理するならこの言語がよき
  - P4-16を使うと良い

- SW実装
  - 新しい機能を追加したいならLinux kernel module
  - 高速にパケット処理したいよ〜 XDP
    - 対応はNICドライバ
  - DPDKはもうUIOを使って直接NICを制御しちゃえ
    - 他のAppと共存はできぬ

- 実装の詳細はコードをみればええんじゃ
  - パーサー実装
  - アクションとマッチテーブル実装

- 実装はtakehayaくんだった
  - どっかに資料出してないかあとでみる

## 後日アーカイブがあればみたいもの
- public DNS とプライバシー
- つぶらな瞳で考える、DNSSECの普及に必要な何かは何か？
- 5Gの夢と現実
- SoftBank インターネット&バックボーンネットワークの進化
- 常識が変わる責任共有のカタチ
- インフラの運用を楽にする情報管理 ~我々のベストプラクティスはこれだ!~



